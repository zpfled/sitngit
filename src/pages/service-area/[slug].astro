---
import BaseLayout from "../../layouts/BaseLayout.astro";
import FAQList from "../../components/FAQList.astro";
import CTABlock from "../../components/CTABlock.astro";
import site from "../../content/site.json";

export function getStaticPaths() {
  const counties = site.service_area.counties;
  const towns = counties.flatMap((county) =>
    county.towns.map((town) => ({ ...town, county }))
  );

  const countyPaths = counties.map((county) => ({
    params: { slug: county.slug }
  }));

  const townPaths = towns.map((town) => ({
    params: { slug: town.slug }
  }));

  return [...countyPaths, ...townPaths];
}

const slug = Astro.params.slug;
const page = site.service_area_pages?.[slug];
const { navigation } = site;
const townSlugs = new Set(
  site.service_area.counties.flatMap((county) => county.towns.map((town) => town.slug))
);
const indexableTownSlugs = new Set(["viroqua-wi", "richland-center-wi"]);
const isTownPage = townSlugs.has(slug);
const allowIndex = !isTownPage || indexableTownSlugs.has(slug);
const countyName = !isTownPage && page?.h1
  ? page.h1.replace(/^Portable Restroom Rentals in\s+/i, "").replace(/,\s*Wisconsin$/i, "")
  : null;
const serviceLinks = [
  { href: "/services/portable-restrooms/", label: "Portable restroom rentals" },
  { href: "/services/ada-restrooms/", label: "ADA accessible restrooms" },
  { href: "/services/handwashing-stations/", label: "Handwashing stations" },
  { href: "/services/event-rentals/", label: "Event rentals" },
  { href: "/services/construction-rentals/", label: "Construction & long-term rentals" }
];
const normalizeHref = (href) => {
  if (typeof href !== "string") return href;
  if (href.startsWith("http") || href.startsWith("mailto:") || href.startsWith("tel:")) return href;
  if (!href.startsWith("/")) return href;
  if (href.includes("?")) {
    const [base, query] = href.split("?");
    return base.endsWith("/") ? `${base}?${query}` : `${base}/?${query}`;
  }
  return href.endsWith("/") ? href : `${href}/`;
};
---
<BaseLayout
  title={page?.title_tag ?? site.pages.service_area.meta_title}
  description={page?.meta_description ?? site.pages.service_area.meta_description}
  noindex={!allowIndex}
>
  <section class="py-12 sm:py-16">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-3xl sm:text-4xl font-display text-ink">{page?.h1 ?? "Service Area"}</h1>
      <div class="mt-4 space-y-4 text-ink/75">
        {page?.intro_paragraphs?.map((paragraph) => (
          <p>{paragraph}</p>
        ))}
      </div>
    </div>
  </section>

  {page?.images?.length ? (
    <section class="py-8 sm:py-12">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 grid gap-6 md:grid-cols-2">
        {page.images.map((image) => (
          <figure class="bg-fog border border-clay/70 rounded-2xl overflow-hidden shadow-soft">
            <img src={image.src} alt={image.alt ?? ""} class="w-full h-64 object-cover" loading="lazy" />
            {image.note && <figcaption class="px-4 py-3 text-xs text-ink/60">{image.note}</figcaption>}
          </figure>
        ))}
      </div>
    </section>
  ) : null}

  <section class="py-8 sm:py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl sm:text-3xl font-display text-ink">{page?.services_title}</h2>
      <ul class="mt-4 space-y-2 text-ink/75 list-disc list-inside">
        {page?.services_list?.map((item) => (
          <li>{item}</li>
        ))}
      </ul>
      {page?.services_note && <p class="mt-4 text-ink/70">{page.services_note}</p>}
    </div>
  </section>

  {!isTownPage && countyName && (
    <section class="py-6 sm:py-10">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl sm:text-3xl font-display text-ink">Services in {countyName}</h2>
        <div class="mt-4 flex flex-wrap gap-3 text-sm font-semibold text-ink/80">
          {serviceLinks.map((link) => (
            <a href={link.href} class="underline underline-offset-4 hover:text-ink">
              {link.label} in {countyName}
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <section class="py-8 sm:py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl sm:text-3xl font-display text-ink">{page?.use_cases_title}</h2>
      <div class="mt-4 space-y-3 text-ink/75">
        {page?.use_cases?.map((item) => (
          <p>{item}</p>
        ))}
      </div>
    </div>
  </section>

  <section class="py-8 sm:py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl sm:text-3xl font-display text-ink">{page?.logistics_title}</h2>
      <p class="mt-4 text-ink/75">{page?.logistics_body}</p>
    </div>
  </section>

  <section class="py-8 sm:py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl sm:text-3xl font-display text-ink">{page?.faq_title}</h2>
      <div class="mt-6">
        <FAQList items={page?.faqs ?? []} />
      </div>
    </div>
  </section>

  <CTABlock
    title={page?.cta_title ?? "Request a Quote"}
    body={page?.cta_body ?? "Tell us your dates and location, and we will confirm availability."}
    button={page?.cta_button ?? "Request a Quote"}
    href={navigation.cta_primary.href}
  />

  {page?.also_serving?.length ? (
    <section class="py-8 sm:py-12">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-ink/70 text-sm">
        <p class="font-semibold text-ink">Also serving:</p>
        <div class="mt-2 flex flex-wrap gap-2">
          {page.also_serving.map((link, index) => (
            <a href={normalizeHref(link.href)} class="hover:text-ink">
              {link.label}{index < page.also_serving.length - 1 ? " Â· " : ""}
            </a>
          ))}
        </div>
      </div>
    </section>
  ) : null}
</BaseLayout>
